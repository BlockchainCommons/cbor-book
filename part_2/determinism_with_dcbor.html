<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Determinism with dCBOR - The CBOR, dCBOR, and Gordian Envelope Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The CBOR, dCBOR, and Gordian Envelope Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="determinism-with-dcbor"><a class="header" href="#determinism-with-dcbor">Determinism with dCBOR</a></h1>
<blockquote>
<p>"Be conservative in what you send, be liberal in what you accept."<br />
— Postel's Law</p>
</blockquote>
<p>John Postel was one of the architects of the early Internet, and his "law" also known as <em>The Robustness Principle</em>, suggests that when designing protocols or systems, you should be strict about the data you produce (i.e., follow the specifications closely) but lenient about the data you accept (i.e., be forgiving of minor deviations from the specifications).</p>
<p>Applying Postel's Law worked especially well— initially— in the context of hand-written HTML, allowing authors to create web pages that would work in most browsers, even if they were not strictly valid HTML. The idea is that by being lenient, you can accommodate a wider range of inputs and make your system more robust. However, this led to HTML parsers becoming more complex and less predictable, as they had to handle a wide variety of malformed HTML.</p>
<p>So it turns out that Postel's Law is a double-edged sword: while it fosters compatibility, it can also mask errors, lead to insecure systems, or encourage sloppy implementations when abused. Recognition of this led to the development of specifications like XHTML, which must validate as well-formed XML, and the HTML5 specification, which is much more explicit about what is allowed and what is not.</p>
<p>So, you're using dCBOR to encode and decode your data: <em>determinism achieved!</em></p>
<p>Well, not really. Determinism as a goal is not a simple problem, and no semantic layer can guarantee it by itself. Technically the top layer, the application, could specify every aspect of a deterministic encoding, but by making choices about the lower layers, you can reduce the cognitive load on the application designers and implementers.</p>
<p>dCBOR identifies and avoids a common set of "foot-guns" that can lead to non-deterministic encodings, so by adopting it you gain those benefits. But when determinism is a goal, you also have to design your data structures with determinism in mind, which is why we visit this topic several times in this book.</p>
<blockquote>
<p>✅ <strong>Note:</strong> <em>Not everyone needs determinism.</em> You might adopt CBOR or even the <code>dCBOR</code> library for other reasons, including its support for Gordian Envelope, which we'll discuss in Part III. Envelope has its own ways of supporting determinism, and its own set of best practices for achieving it.</p>
</blockquote>
<h2 id="optionality"><a class="header" href="#optionality">Optionality</a></h2>
<p>In CBOR there are three common ways to represent “no value” for an otherwise‐required field:</p>
<p>Representation	Example diagnostic	Possible semantic meaning
Omitted key	{name:"Wolf"}	“We do not track this attribute.”
Null value	{name:null}	“We track it but it is unset.”
Empty string	{name:""}	“User explicitly refused to provide it.”</p>
<p>Unless a profile dictates which of the three is authoritative, two encoders can serialize the same high‑level state differently.</p>
<pre><code class="language-cddl">; under‑specified
profile = {
  name : null / tstr,        ; absent also legal
}
</code></pre>
<p>Diagnostic examples that all mean “name is unknown”:</p>
<pre><code class="language-cbor">{name:null}
{}                            ; key omitted
{name:""}                     ; empty string
</code></pre>
<p>Canonical resolution</p>
<p>Decide a single rule and reject the others.  Example: omit the field when unknown.</p>
<pre><code class="language-cddl">profile = {
  ? name : tstr               ; present → non‑empty text only
}
</code></pre>
<p>Canonical encoder:</p>
<pre><code class="language-cbor">{}                            ; unknown
{name:"Wolf"}                ; known
</code></pre>
<p>Decoder rejects {name:null} and {name:""}.</p>
<h2 id="type-choice"><a class="header" href="#type-choice">Type Choice</a></h2>
<p>One concept, many CBOR base types or tags.</p>
<pre><code class="language-cddl">; under‑specified
timestamp = #6.0(tstr) / #6.1(int)
</code></pre>
<p>Same instant, two encodings:</p>
<pre><code class="language-cbor">0("2025-05-07T10:00:00Z")
1(1746621600)
</code></pre>
<p>Canonical rule – “always Tag 1”.</p>
<pre><code class="language-cddl">timestamp = #6.1(int)
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">1(1746621600)
</code></pre>
<h2 id="numeric-normalization"><a class="header" href="#numeric-normalization">Numeric Normalization</a></h2>
<p>Multiple mathematically equivalent encodings after the type is fixed.</p>
<pre><code class="language-cddl">; under‑specified decimal
amount = #6.4([exponent:int, mantissa:int])
</code></pre>
<p>All three mean “one hundred”:</p>
<pre><code class="language-cbor">4([2,1])    ; [2,1]
4([1,10])   ; [1,10]
4([0,100])  ; [0,100]
</code></pre>
<p>Canonical rule – “mantissa has no trailing zeroes, exponent minimal”.</p>
<pre><code class="language-cddl">amount = #6.4([0, uint])   ; exponent always 0
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">4([0,100])
</code></pre>
<h2 id="structural-modeling"><a class="header" href="#structural-modeling">Structural Modeling</a></h2>
<p>Different container shapes for the same record.</p>
<pre><code class="language-cddl">; under‑specified
coord = {lat:float,lon:float}
      / [lat:float,lon:float]
</code></pre>
<p>Equal positions:</p>
<pre><code class="language-cbor">{lat:36.0,lon:-115.0}
[36.0,-115.0]
</code></pre>
<p>Canonical rule – “ordered array only”.</p>
<pre><code class="language-cddl">coord = [lat:float, lon:float]
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">[36.0,-115.0]
</code></pre>
<h2 id="redundancy--aliasing"><a class="header" href="#redundancy--aliasing">Redundancy &amp; Aliasing</a></h2>
<p>Synonymous fields or duplicate information.</p>
<pre><code class="language-cddl">; under‑specified
distance = {
  (meters / kilometres) : float
}
</code></pre>
<p>Two encodings for the same five‑meter length:</p>
<pre><code class="language-cbor">{meters:5.0}
{kilometres:0.005}
</code></pre>
<p>Canonical rule – “meters only”.</p>
<pre><code class="language-cddl">distance = {meters:float}
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">{meters:5.0}
</code></pre>
<h2 id="precision--quantization"><a class="header" href="#precision--quantization">Precision &amp; Quantization</a></h2>
<p>Choice of width or scaling.</p>
<pre><code class="language-cddl">; under‑specified
price = float          ; 19.99 could be any float width
</code></pre>
<pre><code class="language-cbor">fa4198f5c29            ; float32 19.99
fb4033f5c28f5c29f      ; float64 19.99
</code></pre>
<p>Canonical rule – “store cents as unsigned integer”.</p>
<pre><code class="language-cddl">price = uint           ; 19.99 USD → 1999
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">1999
</code></pre>
<h2 id="unit--scale-variation"><a class="header" href="#unit--scale-variation">Unit &amp; Scale Variation</a></h2>
<p>Same quantity in different units.</p>
<pre><code class="language-cddl">; under‑specified
duration = {seconds:uint} / {milliseconds:uint}
</code></pre>
<p>Two encodings for three seconds:</p>
<pre><code class="language-cbor">{seconds:3}
{milliseconds:3000}
</code></pre>
<p>Canonical rule – “microseconds only”.</p>
<pre><code class="language-cddl">duration = {microseconds:uint}
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">{microseconds:3000000}
</code></pre>
<h2 id="tagging-conventions"><a class="header" href="#tagging-conventions">Tagging Conventions</a></h2>
<p>Optional tags or competing tags.</p>
<pre><code class="language-cddl">; under‑specified
blob = bytes / #6.23(tstr)      ; raw vs Base64
</code></pre>
<p>Two encodings for the same bytes:</p>
<pre><code class="language-cbor">h'DEADBEEF'
23(h'DEADBEEF')
</code></pre>
<p>Canonical rule – “raw bytes, never Tag 23”.</p>
<pre><code class="language-cddl">blob = bytes
</code></pre>
<p>Canonical encoding:</p>
<pre><code class="language-cbor">h'DEADBEEF'
</code></pre>
<h2 id="extension-points--unknowns"><a class="header" href="#extension-points--unknowns">Extension Points &amp; Unknowns</a></h2>
<p>Open maps that tolerate extra keys.</p>
<pre><code class="language-cddl">; under‑specified
config = { * tstr =&gt; any }
</code></pre>
<pre><code class="language-cbor">{version:1,foo:7}
{version:1,bar:"x"}
</code></pre>
<p>Canonical rule – closed world with an allow‑list.</p>
<pre><code class="language-cddl">config = {
  version : uint,
  params  : {
    * ("foo" / "bar" / "baz") =&gt; int
  }
}
</code></pre>
<p>Only allowed encoding for version 1 and foo = 7:</p>
<pre><code class="language-cbor">{version:1,params:{foo:7}}
</code></pre>
<blockquote>
<p>🚧 <strong>Work in Progress:</strong> <em>More in this chapter and more chapters forthcoming!</em></p>
</blockquote>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../part_2/dcbor_tags.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../part_3/introducing_gordian_envelope.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../part_2/dcbor_tags.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../part_3/introducing_gordian_envelope.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
